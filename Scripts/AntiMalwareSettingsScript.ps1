$StorageContext = New-AzureStorageContext -StorageAccountName "sispd00sragrssa002" `
                    -StorageAccountKey (Get-AzureStorageKey -StorageAccountName "sispd00sragrssa002").PrimaryP

Get-AzureVM -ServiceName "ContosoService03" -Name"ContosoVM22" | Set-AzureVMMicrosoftAntimalwareExtension `
-AntimalwareConfigFile "C:\configuration\DBVM.json" -Monitoring ON -StorageContext $StorageContext | Update-AzureVM


# Script to add Microsoft Antimalware extension to Azure Resource Manager (IAAS V2) VM’s
# Specify your subscription ID
#$subscriptionId= "SUBSCRIPTION ID HERE"
# specify location, resource group, and VM for the extension
#$location = "LOCATION HERE" # eg., “Southeast Asia” or “Central US”
#$resourceGroupName = "RESOURCE GROUP NAME HERE"
#$vmName = "VM NAME HERE"
# Configuration.JSON configuration file can be customized as per MSDN documentation: https://msdn.microsoft.com/en-us/library/dn771716.aspx
#$settingString = ‘{"AntimalwareEnabled": true}’;
# Login to your Azure Resource Manager Account and select the Subscription to use
Login-AzureRmAccount
Select-AzureRmSubscription -SubscriptionId $subscriptionId
# retrieve the most recent version number of the extension
$allVersions= (Get-AzureRmVMExtensionImage -Location $location -PublisherName “Microsoft.Azure.Security” `
-Type “IaaSAntimalware”).Version
$versionString = $allVersions[($allVersions.count)-1].Split(“.”)[0] + “.” + $allVersions[($allVersions.count)-1].Split(“.”)[1]
# set the extension using prepared values
# ****—-Use this script till cmdlets address the -SettingsString format issue we observed ****—-
Set-AzureRmVMExtension -ResourceGroupName $resourceGroupName -Location $location -VMName $vmName -Name "IaaSAntimalware" `
-Publisher “Microsoft.Azure.Security” `
-ExtensionType “IaaSAntimalware” -TypeHandlerVersion $versionString -SettingString $settingString